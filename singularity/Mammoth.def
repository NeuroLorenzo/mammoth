Bootstrap: docker
From: debian:bookworm

%labels
    Author Lorenzo Tartarini
    Version 1.1
    Description "Singularity container for Mammoth"

%files
    ../mammoth /opt/mammoth

%post
    set -e

    echo "Installing system dependencies..."
    apt-get update && apt-get install -y --no-install-recommends \
        python3 \
        python3-dev \
        python3-pip \
        python3-venv \
        build-essential \
        gcc g++ gfortran \
        cmake make \
        git wget curl \
        zlib1g-dev \
        libltdl-dev \
        libgsl-dev \
        liblapack-dev \
        libbz2-dev \
        liblzma-dev \
        libssl-dev \
        libffi-dev \
        libsqlite3-dev \
        libncurses5-dev \
        libreadline-dev \
        libgdbm-dev \
        libnss3-dev \
        libgl1-mesa-dev \
        libgl1-mesa-glx \
        libsm6 libxext6 xvfb \
        ffmpeg \
        libpapi-dev papi-tools \
    && apt-get clean \
    && rm -rf /var/lib/apt/lists/*

    python3 -m venv /opt/mammoth_env
    . /opt/mammoth_env/bin/activate

    pip install --upgrade pip setuptools wheel
    echo "Installing Mammoth requirements..."
    cd /opt/mammoth
    pip install -r requirements.txt

    pip install notebook jupyterlab ipykernel
    
    echo "Basic sanity check..."
    python3 utils/main.py --help || true

%environment
    export PYTHONUNBUFFERED=1
    export PYTHONPATH=/opt:$PYTHONPATH
    export PATH=/opt/mammoth_env/bin:$PATH

%test
    echo "Running container test..."
    python3 --version
    python3 -c "import sys; print(sys.executable)"
    pip list | head

%runscript
    exec python3 "$@"
